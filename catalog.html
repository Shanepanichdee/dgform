<!DOCTYPE html>
<html lang="th">

<head>
    <script>
        if (!localStorage.getItem('isLoggedIn') && !window.location.href.includes('login.html') && !window.location.href.includes('splash.html')) {
            window.location.href = 'login.html' + window.location.search;
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DG Data Catalog Explorer</title>

    <!-- Google Fonts: Sarabun & Prompt -->
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Sarabun', sans-serif;
            transition: font-family 0.3s ease;
        }

        body.font-prompt {
            font-family: 'Prompt', sans-serif;
        }

        /* Dark Mode Overrides */
        [data-bs-theme="dark"] body {
            background-color: #121212;
            color: #e0e0e0;
        }

        [data-bs-theme="dark"] .bg-white,
        [data-bs-theme="dark"] .card {
            background-color: #1e1e1e !important;
            color: #e0e0e0;
            border-color: #444 !important;
        }

        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select,
        [data-bs-theme="dark"] .input-group-text {
            background-color: #2b2b2b;
            color: #e0e0e0;
            border-color: #444;
        }

        [data-bs-theme="dark"] .form-control:focus,
        [data-bs-theme="dark"] .form-select:focus {
            background-color: #333;
            color: #fff;
            border-color: #6497b1;
        }

        [data-bs-theme="dark"] .text-muted,
        [data-bs-theme="dark"] .text-secondary {
            color: #999 !important;
        }

        [data-bs-theme="dark"] .text-dark {
            color: #e0e0e0 !important;
        }

        [data-bs-theme="dark"] .bg-light {
            background-color: #2b2b2b !important;
        }

        [data-bs-theme="dark"] .table {
            color: #e0e0e0;
            border-color: #444;
        }

        [data-bs-theme="dark"] .table th,
        [data-bs-theme="dark"] .table td {
            background-color: transparent !important;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-bs-theme="dark"] .domain-badge {
            background-color: #2b4555;
            color: #90caf9;
        }

        [data-bs-theme="dark"] .tag-badge {
            background-color: #3a5c72;
            color: #fff;
        }

        [data-bs-theme="dark"] .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border-color: #444;
        }

        .hero {
            background: linear-gradient(135deg, #005b96, #003366);
            color: white;
            padding: 4rem 0;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dataset-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            background-color: white;
        }

        .dataset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .tag-badge {
            background-color: #e9ecef;
            color: #495057;
            font-weight: normal;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .domain-badge {
            background-color: #e0f2fe;
            color: #0284c7;
        }

        .loading-spinner {
            display: none;
            margin: 40px auto;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: white;
        }
    </style>
</head>

<body>

    <!-- Top Navigation -->
    <div class="bg-dark text-white py-2 shadow-sm sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-shield-check me-2 text-primary fs-5"></i> <span class="fw-bold">Data Governance</span>
            </div>
            <div class="d-flex align-items-center gap-3 nav-links">
                <button type="button" class="btn btn-sm btn-outline-light border-2 fw-bold" onclick="toggleDarkMode()"
                    id="darkModeBtn">
                    <i class="bi bi-moon-stars-fill me-1"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô
                </button>
                <button type="button" class="btn btn-sm btn-outline-light border-2 fw-bold" onclick="toggleFont()"
                    id="fontToggleBtn">
                    <i class="bi bi-fonts me-1"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå (Prompt)
                </button>
                <button type="button" class="btn btn-sm btn-outline-light border-2 fw-bold ms-2" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="hero mb-5">
        <div class="container text-center">
            <h1 class="display-5 fw-bold mb-3"><i class="bi bi-search me-2"></i>Data Catalog Explorer</h1>
            <p class="lead mb-4 opacity-75">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="input-group input-group-lg shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i
                                class="bi bi-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0 ps-0 form-control-lg"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Keywords), ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..."
                            onkeyup="handleSearch()">
                        <button class="btn btn-primary px-4 fw-bold" onclick="filterData()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container pb-5">
        <div
            class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 bg-white p-3 rounded-4 shadow-sm border">
            <h5 class="fw-bold m-0 text-secondary mb-3 mb-md-0" id="resultCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</h5>
            <div class="d-flex align-items-center gap-2 w-100" style="max-width: 350px;">
                <label class="text-muted small text-nowrap"><i class="bi bi-funnel me-1"></i>‡πÇ‡∏î‡πÄ‡∏°‡∏ô (Business
                    Domain):</label>
                <select id="domainFilter" class="form-select border-0 bg-light fw-bold text-primary"
                    onchange="filterData()">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                    <option value="Agriculture">‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ (Agriculture)</option>
                    <option value="Industry">‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° (Industry)</option>
                    <option value="Economy">‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏Ø</option>
                    <option value="Commerce">‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                    <option value="TourismSports">‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏µ‡∏¨‡∏≤</option>
                    <option value="Education">‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Education)</option>
                    <option value="Energy">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (Energy)</option>
                    <option value="Environment">‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏Ø</option>
                    <option value="Health">‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                    <option value="SecurityLaw">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</option>
                    <option value="Society">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</option>
                    <option value="ScienceTech">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                    <option value="Transport">‡∏Å‡∏≤‡∏£‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå</option>
                    <option value="Population">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏´‡∏∞</option>
                    <option value="CultureReligion">‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡∏®‡∏¥‡∏•‡∏õ‡∏∞ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
                    <option value="Infrastructure">‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
                    <option value="ForeignAffairs">‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                    <option value="Labor">‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô (Labor)</option>
                    <option value="PublicAdmin">‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê</option>
                    <option value="Other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)</option>
                </select>
            </div>
        </div>

        <div class="text-center loading-spinner" id="loadingState">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <!-- Results Grid -->
        <div class="row g-4" id="catalogGrid">
            <!-- Cards injected via JS -->
        </div>

        <div id="noDataState" class="text-center p-5 d-none bg-white rounded-4 shadow-sm mt-3 border">
            <i class="bi bi-folder-x display-1 text-muted opacity-25 mb-3 d-block"></i>
            <h4 class="text-muted fw-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h4>
            <p class="text-muted small">‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Keywords) ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏î‡πÄ‡∏°‡∏ô</p>
            <button class="btn btn-outline-secondary mt-2 px-4 rounded-pill"
                onclick="clearSearch()">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <!-- Dataset Detail Modal -->
    <div class="modal fade" id="datasetDetailModal" tabindex="-1" aria-labelledby="datasetDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="datasetDetailModalLabel"><i
                            class="bi bi-info-circle me-2"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Metadata Catalog)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" id="modalBodyContent">
                    <!-- Content injected via JS -->
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-warning fw-bold px-4" id="modalEditLink" style="display:none;">
                        <i class="bi bi-pencil-square me-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin Only)
                    </button>
                    <button type="button" class="btn btn-secondary fw-bold px-4"
                        data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                    <a href="#" class="btn btn-outline-primary fw-bold px-4" id="modalExternalLink" target="_blank"
                        style="display:none;"><i class="bi bi-box-arrow-up-right me-1"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
                        (‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î)</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allDatasets = [];
        let searchTimeout = null;
        window.currentScriptUrl = '';

        // Load Config Logic from index.html (Shared Code)
        function loadConfig() {
            const shortcodes = {
                'dla': { url: 'https://dgform-proxy.shanepanichdee.workers.dev/?id=dla' },
                'dla2': { url: 'https://dgform-proxy.shanepanichdee.workers.dev/?id=dla2' },
                'diw': { url: 'https://dgform-proxy.shanepanichdee.workers.dev/?id=diw' },
                'diw2': { url: 'https://dgform-proxy.shanepanichdee.workers.dev/?id=diw2' }
            };

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å LocalStorage (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å URL ( fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Å‡πà‡∏≤ )
            const shortcodeId = localStorage.getItem('agencyId') || urlParams.get('id');

            let config = null;

            if (shortcodeId && shortcodes[shortcodeId.toLowerCase()]) {
                config = shortcodes[shortcodeId.toLowerCase()];
            } else if (token) {
                // Future expansion: fetch config from token API
                // For now, demo falls back to dla2 if token is invalid
                config = shortcodes['dla2'];
            } else {
                // Absolute Default Fallback (Lock to dla2 as requested by Admin)
                config = shortcodes['dla2'];
            }

            if (config && config.url) {
                window.currentScriptUrl = config.url;
            } else {
                window.currentScriptUrl = '';
            }
        }

        async function fetchData() {
            if (!window.currentScriptUrl) {
                document.getElementById('resultCount').innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ?id=dla)</span>';
                document.getElementById('loadingState').style.display = 'none';
                return;
            }

            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('catalogGrid').innerHTML = '';
            document.getElementById('resultCount').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Repository...';

            try {
                // Fetch data via GET request (Triggers doGet in Apps Script)
                const response = await fetch(window.currentScriptUrl);
                const data = await response.json();

                if (data.result === 'success') {
                    // Reverse to show newest on top
                    allDatasets = (data.data || []).reverse();
                    populateDynamicDomains();
                    filterData();
                } else {
                    throw new Error(data.message || "Unknown Error from Server");
                }
            } catch (err) {
                console.error("Fetch Data Error:", err);
                document.getElementById('resultCount').innerHTML = '<span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô doGet()</span>';
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterData, 300); // Debounce to prevent lag while typing
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('domainFilter').value = 'all';
            filterData();
        }

        function populateDynamicDomains() {
            const select = document.getElementById('domainFilter');
            const existingValues = Array.from(select.options).map(opt => opt.value);

            // Extract unique domains from actual data
            const uniqueDomains = [...new Set(allDatasets.map(item => item.domain).filter(Boolean))];

            uniqueDomains.forEach(domain => {
                if (!existingValues.includes(domain)) {
                    const option = document.createElement('option');
                    option.value = domain;
                    option.textContent = domain;
                    select.appendChild(option);
                }
            });
        }

        function filterData() {
            const getCountHtml = (count) => `<i class="bi bi-card-list me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="text-primary fw-bold mx-1">${count}</span> ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;

            if (allDatasets.length === 0) {
                document.getElementById('resultCount').innerHTML = getCountHtml(0);
                document.getElementById('noDataState').classList.remove('d-none');
                return;
            }

            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const domain = document.getElementById('domainFilter').value;

            const domainMap = {
                'Agriculture': ['agriculture', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£'],
                'Industry': ['industry', '‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°'],
                'Economy': ['economy', '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à', '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á'],
                'Commerce': ['commerce', '‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå', '‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£'],
                'TourismSports': ['tourism', 'tourismsports', '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', '‡∏Å‡∏µ‡∏¨‡∏≤'],
                'Education': ['education', '‡∏®‡∏∂‡∏Å‡∏©‡∏≤'],
                'Energy': ['energy', '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô'],
                'Environment': ['enviro', '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°', '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£'],
                'Health': ['health', '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'],
                'SecurityLaw': ['security', 'securitylaw', '‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á', '‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢'],
                'Society': ['society', '‡∏™‡∏±‡∏á‡∏Ñ‡∏°', '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£'],
                'ScienceTech': ['science', 'sciencetech', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ', '‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•'],
                'Transport': ['transport', '‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå'],
                'Population': ['population', '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£', '‡πÄ‡∏Ñ‡∏´‡∏∞'],
                'CultureReligion': ['culture', 'culturereligion', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤', '‡∏®‡∏¥‡∏•‡∏õ‡∏∞', '‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°'],
                'Infrastructure': ['infrastructure', '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô'],
                'ForeignAffairs': ['foreign', 'foreignaffairs', '‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®'],
                'Labor': ['labor', '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô'],
                'PublicAdmin': ['admin', 'publicadmin', '‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', '‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê'],
                'Other': ['other', '‡∏≠‡∏∑‡πà‡∏ô']
            };

            const filtered = allDatasets.filter(item => {
                const allTextContent = Object.values(item).map(v => String(v || '')).join(' ').toLowerCase();

                // Domain Match (Robust mapping check across possible schema keys and legacy fields)
                let matchDomain = false;
                if (domain === 'all') {
                    matchDomain = true;
                } else {
                    // Check all possible keys where domain might have been saved in Google Sheets history, 
                    // including topicCategory and keywords to catch legacy data categorization.
                    let rawItemDomain = String(
                        (item.domain || "") + " " +
                        (item.businessDomain || "") + " " +
                        (item.businessdomain || "") + " " +
                        (item['Business Domain'] || "") + " " +
                        (item.topicCategory || "") + " " +
                        (item.keywords || "")
                    ).toLowerCase();

                    // If absolutely nothing is found in domain/category columns, search the entire record
                    if (!rawItemDomain.trim()) rawItemDomain = allTextContent;

                    const filterKeywords = domainMap[domain] || [domain.toLowerCase()];
                    matchDomain = filterKeywords.some(kw => rawItemDomain.includes(kw));
                }

                // Advanced Free Text Match (Deep Search across all properties)
                const matchQuery = !query || allTextContent.includes(query);

                return matchDomain && matchQuery;
            });

            renderCards(filtered);
        }

        function renderCards(datasets) {
            document.getElementById('resultCount').innerHTML = `<i class="bi bi-card-list me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á <span class="text-primary fw-bold mx-1">${datasets.length}</span> ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
            const grid = document.getElementById('catalogGrid');
            const noData = document.getElementById('noDataState');

            grid.innerHTML = '';

            if (datasets.length === 0) {
                noData.classList.remove('d-none');

                // --- DEBUG BLOCK --- (Helps see what data actually exists when filter fails)
                const debugHtml = `<div class="mt-4 p-3 bg-light border text-start rounded text-muted" style="font-size:10px; max-height:200px; overflow-y:auto; word-wrap:break-word;">
                    <strong>[Debug Info - Admin Only] Total DB Items: ${allDatasets.length}</strong><br>
                    <pre>${JSON.stringify(allDatasets.slice(0, 5), null, 2)}</pre>
                </div>`;

                // Append only once
                let debugDiv = document.getElementById('debugDump');
                if (!debugDiv) {
                    debugDiv = document.createElement('div');
                    debugDiv.id = 'debugDump';
                    noData.appendChild(debugDiv);
                }
                debugDiv.innerHTML = debugHtml;
                // -------------------

                return;
            } else {
                noData.classList.add('d-none');
            }

            datasets.forEach(item => {
                // Convert CSV keywords to Badges
                let keywordBadges = '';
                if (item.keywords && item.keywords.trim() !== '') {
                    const kwArray = String(item.keywords).split(',');
                    keywordBadges = kwArray.map(kw => `<span class="badge tag-badge shadow-sm">${kw.trim()}</span>`).join('');
                } else {
                    keywordBadges = `<span class="badge bg-light text-muted border fst-italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å (No Tags)</span>`;
                }

                // Check privacy
                const isPrivate = String(item.classification || '').toLowerCase().includes('private');
                const lockIcon = isPrivate ? 'bi-shield-lock-fill text-danger' : 'bi-shield-check text-success';
                const classLabel = item.classification || 'Private';

                // Display Domain Mapping
                const displayDomainMap = {
                    'Agriculture': '‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ (Agriculture)',
                    'Industry': '‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° (Industry)',
                    'Economy': '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏Ø',
                    'Commerce': '‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
                    'TourismSports': '‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏µ‡∏¨‡∏≤',
                    'Education': '‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Education)',
                    'Energy': '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (Energy)',
                    'Environment': '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏Ø',
                    'Health': '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                    'SecurityLaw': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢',
                    'Society': '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£',
                    'ScienceTech': '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
                    'Transport': '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå',
                    'Population': '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏´‡∏∞',
                    'CultureReligion': '‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡∏®‡∏¥‡∏•‡∏õ‡∏∞ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°',
                    'Infrastructure': '‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô',
                    'ForeignAffairs': '‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®',
                    'Labor': '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô (Labor)',
                    'PublicAdmin': '‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê',
                    'Other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)'
                };

                // Fallback to original value if it's already Thai or doesn't match the map
                const rawDomain = item.domain || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const displayDomain = displayDomainMap[rawDomain] || rawDomain;

                const card = document.createElement('div');
                card.className = 'col-lg-4 col-md-6';
                card.innerHTML = `
                    <div class="card dataset-card h-100 p-2">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="badge domain-badge fs-6"><i class="bi bi-briefcase me-1"></i> ${displayDomain}</span>
                                    <span class="badge bg-light text-dark border ms-1"><i class="bi ${lockIcon} me-1"></i> ${classLabel}</span>
                                </div>
                                <button class="btn btn-sm btn-light text-warning border border-warning shadow-sm" style="position: relative; z-index: 2;" onclick="editDataset(event, '${item.datasetId}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)"><i class="bi bi-pencil-square"></i></button>
                            </div>
                            <h5 class="card-title fw-bold text-primary mb-1 mt-2 line-clamp-2" title="${item.title || 'Untitled'}">${item.title || '<span class="text-danger fst-italic">Untitled Dataset</span>'}</h5>
                            <p class="text-muted small mb-3"><i class="bi bi-building me-1"></i> ${item.submitterAgency || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'}</p>
                            
                            <p class="card-text small text-secondary flex-grow-1" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; height: 4.5em;">
                                ${item.description || '<span class="text-muted fst-italic">...‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ...</span>'}
                            </p>
                            
                            <div class="mt-3 border-top pt-3">
                                <div class="d-flex flex-wrap gap-1">
                                    ${keywordBadges}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-0 text-end pb-3 px-3">
                            <button class="btn btn-sm btn-outline-primary fw-bold px-3 w-100 stretched-link" onclick="showDetail('${item.datasetId}')"><i class="bi bi-eye me-1"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function showDetail(datasetId) {
            const dataset = allDatasets.find(d => String(d.datasetId) === String(datasetId));
            if (!dataset) return;

            const modalBody = document.getElementById('modalBodyContent');

            // Format timestamps reliably
            const formatLocDate = (dString) => {
                if (!dString) return '-';
                try {
                    const d = new Date(dString);
                    if (isNaN(d.getTime())) return dString;
                    return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (e) { return dString; }
            };

            const created = formatLocDate(dataset.createdDate);
            const updated = formatLocDate(dataset.lastModifiedDate);

            // Convert CSV keywords to Badges
            let keywordBadges = '';
            if (dataset.keywords && dataset.keywords.trim() !== '') {
                const kwArray = String(dataset.keywords).split(',');
                keywordBadges = kwArray.map(kw => `<span class="badge tag-badge shadow-sm">${kw.trim()}</span>`).join('');
            } else {
                keywordBadges = `<span class="text-muted fst-italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å (No Tags)</span>`;
            }

            modalBody.innerHTML = `
                <h4 class="fw-bold text-primary mb-3">${dataset.title || 'Untitled Dataset'}</h4>
                <p class="text-muted mb-4"><i class="bi bi-building me-1"></i> ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: <strong>${dataset.submitterAgency || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong></p>
                
                <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3"><i class="bi bi-card-text me-2"></i>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Description)</h6>
                <p class="mb-4">${dataset.description || '<span class="text-muted fst-italic">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</span>'}</p>

                <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3"><i class="bi bi-bullseye me-2"></i>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (Objective)</h6>
                <p class="mb-4">${dataset.objective || '<span class="text-muted fst-italic">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</span>'}</p>

                <h6 class="fw-bold text-secondary border-bottom pb-2 mb-3"><i class="bi bi-list-columns-reverse me-2"></i>‡∏Ñ‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Properties)</h6>
                <div class="table-responsive mb-4">
                    <table class="table table-bordered table-sm rounded shadow-sm align-middle">
                        <tbody>
                            <tr>
                                <th class="bg-light text-end pe-3" style="width: 35%;">‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Domain)</th>
                                <td class="ps-3">${dataset.domain || '-'}</td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</th>
                                <td class="ps-3">${dataset.topicCategory || '-'}</td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</th>
                                <td class="ps-3"><span class="badge ${String(dataset.classification).toLowerCase().includes('private') ? 'bg-danger' : 'bg-success'}">${dataset.classification || 'Private'}</span></td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</th>
                                <td class="ps-3">${dataset.updateFreqValue || ''} ${dataset.updateFreqUnit || '-'}</td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå (Format)</th>
                                <td class="ps-3"><span class="badge border border-secondary text-secondary">${dataset.fileFormat || '-'}</span></td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (License)</th>
                                <td class="ps-3">${dataset.license || '-'}</td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                <td class="ps-3">${created}</td>
                            </tr>
                            <tr>
                                <th class="bg-light text-end pe-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <td class="ps-3">${updated}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-2">
                    <h6 class="fw-bold text-secondary mb-2"><i class="bi bi-tags me-2"></i>‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Keywords)</h6>
                    <div>${keywordBadges}</div>
                </div>
                
                <!-- Placeholder for Data Dictionary and Glossary (Lazy Loaded) -->
                <div id="dictGlossaryContainer" class="mt-4">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°...
                    </div>
                </div>
            `;

            // Action button (External link if provided)
            const externalBtn = document.getElementById('modalExternalLink');
            if (dataset.accessUrl && dataset.accessUrl.trim() !== '') {
                externalBtn.href = dataset.accessUrl;
                externalBtn.style.display = 'inline-block';
            } else {
                externalBtn.style.display = 'none';
            }

            // Edit button setup (Admin Only)
            const editBtn = document.getElementById('modalEditLink');
            editBtn.style.display = 'inline-block';
            editBtn.onclick = () => {
                const pwd = prompt("üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Admin Password):");
                if (pwd !== "admin1234") {
                    if (pwd !== null) alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                    return; // Cancel edit
                }
                sessionStorage.setItem('editAuthed_' + dataset.datasetId, 'true');

                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                const token = urlParams.get('token');

                let editUrl = `index.html?editId=${encodeURIComponent(dataset.datasetId)}`;
                if (id) editUrl += `&id=${id}`;
                else if (token) editUrl += `&token=${token}`;

                window.location.href = editUrl;
            };

            // Init & Show Modal
            const detailModal = new bootstrap.Modal(document.getElementById('datasetDetailModal'));
            detailModal.show();

            // Lazy Load Full Dataset Details (Dictionary & Glossary)
            if (window.currentScriptUrl) {
                const urlObj = new URL(window.currentScriptUrl);
                urlObj.searchParams.append('action', 'getDataset');
                urlObj.searchParams.append('datasetId', dataset.datasetId);

                fetch(urlObj.toString())
                    .then(res => res.json())
                    .then(fullDataResult => {
                        const container = document.getElementById('dictGlossaryContainer');
                        if (fullDataResult.result === 'success' && fullDataResult.data) {
                            const fullData = fullDataResult.data;
                            let html = '';

                            // Render Data Dictionary if exists
                            if (fullData.dictionary && fullData.dictionary.length > 0) {
                                html += `
                                    <h6 class="fw-bold text-secondary border-bottom pb-2 mt-4 mb-3"><i class="bi bi-journal-text me-2"></i>‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Dictionary)</h6>
                                    <div class="table-responsive mb-4">
                                        <table class="table table-bordered table-striped table-sm align-middle" style="font-size: 0.9em;">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Variable/‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå)</th>
                                                    <th>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Description)</th>
                                                    <th>‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Type)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;
                                fullData.dictionary.forEach(dict => {
                                    html += `
                                        <tr>
                                            <td class="fw-bold text-primary">${dict.variable || '-'}</td>
                                            <td>${dict.description || '-'}</td>
                                            <td class="text-center"><span class="badge bg-secondary">${dict.type || '-'}</span></td>
                                        </tr>
                                    `;
                                });
                                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                `;
                            }

                            // Render Glossary if exists
                            if (fullData.glossary && fullData.glossary.length > 0) {
                                html += `
                                    <h6 class="fw-bold text-secondary border-bottom pb-2 mt-4 mb-3"><i class="bi bi-translate me-2"></i>‡∏≠‡∏†‡∏¥‡∏ò‡∏≤‡∏ô‡∏®‡∏±‡∏û‡∏ó‡πå (Glossary)</h6>
                                    <div class="table-responsive mb-4">
                                        <table class="table table-bordered table-striped table-sm align-middle" style="font-size: 0.9em;">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th>‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (Term)</th>
                                                    <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ (Definition)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;
                                fullData.glossary.forEach(glos => {
                                    html += `
                                        <tr>
                                            <td class="fw-bold" style="width: 30%;">${glos.term || '-'}</td>
                                            <td>${glos.definition || '-'}</td>
                                        </tr>
                                    `;
                                });
                                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                `;
                            }

                            if (html === '') {
                                html = '<p class="text-muted fst-italic mt-4 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡∏á‡∏≠‡∏†‡∏¥‡∏ò‡∏≤‡∏ô‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</p>';
                            }

                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<div class="alert alert-warning py-2 mt-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
                        }
                    })
                    .catch(err => {
                        console.error('Failed to load dictionary:', err);
                        document.getElementById('dictGlossaryContainer').innerHTML = '<div class="alert alert-danger py-2 mt-3"><i class="bi bi-x-circle-fill me-2"></i>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°</div>';
                    });
            } else {
                document.getElementById('dictGlossaryContainer').innerHTML = '';
            }
        }


        function editDataset(event, datasetId) {
            if (event) event.stopPropagation();

            const dataset = allDatasets.find(d => String(d.datasetId) === String(datasetId));
            if (!dataset) return;

            const pwd = prompt("üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Admin Password):");
            if (pwd !== "admin1234") {
                if (pwd !== null) alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                return; // Cancel edit
            }
            sessionStorage.setItem('editAuthed_' + dataset.datasetId, 'true');

            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const token = urlParams.get('token');

            let editUrl = `index.html?editId=${encodeURIComponent(dataset.datasetId)}`;
            if (id) editUrl += `&id=${id}`;
            else if (token) editUrl += `&token=${token}`;

            window.location.href = editUrl;
        }


        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            // Apply Theme/Font preferences
            if (localStorage.getItem('preferredFont') === 'prompt') {
                document.body.classList.add('font-prompt');
                const ftBtn = document.getElementById('fontToggleBtn');
                if (ftBtn) ftBtn.innerHTML = '<i class="bi bi-fonts me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Sarabun';
            }
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
                const dkBtn = document.getElementById('darkModeBtn');
                if (dkBtn) dkBtn.innerHTML = '<i class="bi bi-sun-fill me-1"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
            }

            loadConfig();
            fetchData();
        });

        // Theme and Font Logic
        function toggleFont() {
            const body = document.body;
            const btn = document.getElementById('fontToggleBtn');
            body.classList.toggle('font-prompt');

            if (body.classList.contains('font-prompt')) {
                btn.innerHTML = '<i class="bi bi-fonts me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Sarabun';
                localStorage.setItem('preferredFont', 'prompt');
            } else {
                btn.innerHTML = '<i class="bi bi-fonts me-1"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå (Prompt)';
                localStorage.setItem('preferredFont', 'sarabun');
            }
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const btn = document.getElementById('darkModeBtn');

            if (html.getAttribute('data-bs-theme') === 'dark') {
                html.setAttribute('data-bs-theme', 'light');
                btn.innerHTML = '<i class="bi bi-moon-stars-fill me-1"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-bs-theme', 'dark');
                btn.innerHTML = '<i class="bi bi-sun-fill me-1"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
                localStorage.setItem('theme', 'dark');
            }
        }

        function logout() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (Are you sure you want to logout?)')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');

                // Clear any stored admin session keys for editing
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('editAuthed_')) {
                        sessionStorage.removeItem(key);
                    }
                });

                window.location.href = 'login.html';
            }
        }
    </script>
</body>

</html>